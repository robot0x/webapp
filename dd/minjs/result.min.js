/*! diaodiao 李彦峰 2015-10-24 */
$.extend({getParam:function(){var a,b,c,d,e,f=window.location.href,g=f.split("?"),h={},i=0;if(g.length>1&&(c=g[1]),c)for(a=c.split("&"),b=a.length;b>i;i++)d=a[i],e=d.split("="),h[e[0]]=decodeURIComponent(e[1]);return h}}),$(function(){function a(){z=$(this);var a=this.getAttribute("data-group");if("scene"===a){if(x&&(x.removeClass("cur-select"),x.attr("data-title")===z.attr("data-title")))return x=void 0,void b();z.addClass("cur-select"),x=z}else if("relation"===a){if(y&&(y.removeClass("cur-select"),y.attr("data-title")===z.attr("data-title")))return y=void 0,void b();z.addClass("cur-select"),y=z}else("character"===a||"price"===a)&&z.toggleClass("cur-select");b()}function b(){var a=c(),b=A.meta_infos,d={};if(a&&a.length)a.forEach(function(a){b[a]&&(d[a]=b[a])}),$(".no-result").hide(),$(".no-result p.f-l").html('找不到<span class="target-word"></span>，换个关键词试试'),f(d);else{var e=document.querySelectorAll(".cur-select");e.length?(document.getElementById("goodthing-list").innerHTML="",$(".no-result").show(),$(".no-result p.f-l").text("没有结果，换个组合试试"),j("none")):f(b)}}function c(){var a,b,c=$(".scene .cur-select,.relation .cur-select,.character .cur-select"),d=$(".price .cur-select"),f=[],g=[],h=[],i=[],j=[],k=[];return c.each(function(a,b){"character"===b.getAttribute("data-group")?g.push(b.getAttribute("data-title")):h.push(b.getAttribute("data-title"))}),g.length&&(i=[],g.forEach(function(a){i.push(B[a])}),j.push(i.reduce(function(a,b){return a.concat(b)}).unique())),d.length&&d.each(function(a,b){f.push(b.getAttribute("data-title"))}),f.length&&(a=e(f),j.push(a)),h.forEach(function(a){j.push(B[a])}),j.length&&(b=j.reduce(function(a,b){return a.forEach(function(a){b.forEach(function(b){a===b&&k.push(a)})}),k})),b}function d(a){if(null==a)return!0;for(var b in a)return!1;return!0}function e(a){var b,c,d,e,f,g=/\d+((\.|,)\d+)?/g,h=[],i=A.meta_infos;return a.forEach(function(a){b=a.split("-");for(d in i)d=+d,e=i[d],c=e.has_buylink,f=e.price,c&&f&&(f=f.match(g),f&&f.length&&(f=f[0],-1!==f.indexOf(",")&&(f=f.split(",").join("")),f=parseFloat(f)),f>=b[0]&&(b[1]?f<b[1]&&-1===h.indexOf(d)&&h.push(d):-1===h.indexOf(d)&&h.push(d)))}),h}function f(a){var b,c,d,e,f,g=document.getElementById("goodthing-list"),h=[];gift_tag_index=H.gift_tag_index,count=0,g.innerHTML="";for(b in a){if(count++>=8){C=a;break}everyMeta=a[b],everyMeta&&(c=everyMeta.cover_image_url,d=everyMeta.rendered_title,f=everyMeta.price,everyMeta.has_buylink&&null!=f&&"N/A"!==f||(f="&nbsp"),e=everyMeta.url,e&&(match=e.match(s),match&&match.length?e=match[0].replace(s,u):(match=e.match(t),match&&match.length&&(e=match[0].replace(t,u)))),c&&-1==c.indexOf("http")&&(c="http://a.diaox2.com/cms/sites/default/files/"+c),h.push('<li class="goodthing"><a href="http://www.diaox2.com/',e,'" target="_blank"><div class="img-container"><img src="',c,'" alt="',d,'" onload="adjust(this)"></div><div class="goodthing-highlight"><h2><div>',d,'</div></h2><ul class="icon-list clearfix"><li class="icon-item f-l"><span>',f,'</span></li><li class="icon-item f-r"><i class="icon icon-s"></i><span>...</span></li><li class="icon-item f-r"><i class="icon icon-z"></i><span>...</span></li></ul></div></a></li>'),delete a[b])}document.getElementById("goodthing-list").innerHTML=h.join("")}function g(){var b=r.split("+").join(""),c=Array.prototype.slice.call(document.querySelectorAll(".present-type li"));c.forEach(function(c){-1!==b.indexOf(c.innerHTML)&&a.call(c)})}function h(a){A=a;var b=a.gift_tag_index;return $.extend(B,b.scene,b.relation,b.character),"礼物"!==r?void g():void f(a.meta_infos)}function i(a){if(a.count>0){var b,c,d,e,f,g,h,i=a.aids,j=a.meta_infos,k="",l=[];$.each(i,function(a,i){b=j[i],e=k="",b.price||(b.price="<img width='15' height='15' style='margin-right:5px;' src='http://c.diaox2.com/cms/diaodiao/assets/links.png'>全网结果"),c=b.rendered_keywords,$.each(c,function(a,b){k+=0==a&&b[0]==r?'<li class="f-l"><span class="target-word">'+b[0]+"</span></li>":'<li class="f-l">'+b[0]+"</li>"}),d=b.rendered_title,h=b.thumb_image_url,-1==h.indexOf("http")&&(h="http://a.diaox2.com/cms/sites/default/files/"+h),e=b.author.src||b.author.url,-1==e.indexOf("http")&&(e="editor/"+e+".html"),d=d.replace(/<<<<(.*?)>>>>/gi,"<span class='target-word'>$1</span>"),f=b.url,g=f.match(s),g&&g.length?f=g[0].replace(s,u):(g=f.match(t),g&&g.length&&(f=g[0].replace(t,u)));var m=b.price;(b.has_buylink===!1||"N/A"===b.price)&&(m="&nbsp"),l.push('<li class="result-item" data-pos=',a+1,'><a target="_blank" href="http://www.diaox2.com/','" class="imglink f-l"><div class="result-item-img-container loading"><img src="',h,'" alt="',c,'" width="188" height="188"></div></a><div class="result-item-detail f-l"><h2 class="detail-title"><a target="_blank" href="',f,'">',d,'</a></h2><ul class="detail-keywords clearfix">',k,'</ul><div class="detail-author clearfix"><a class="detail f-l">',m,'</a><div class="author f-l clearfix"><ul class="clearfix"><li class="author-face f-l"><a target="_blank" href="',e,'"><span class="author-face-container"><img src="http://c.diaox2.com/cms/diaodiao/',b.author.pic,'" width="20" height="20"></span></a></li><li class="author-name f-l"><a target="_blank" href="',e,'">',b.author.name,"</a></li></ul></div></div></div></li>")}),document.getElementById("result-list").innerHTML=l.join("")}else $(".no-result").find(".target-word").html("“"+(void 0==r?"":r)+"”"),$(".no-result").addClass("disblk");var m=$(".result-item"),f=(m.attr("data-pos"),m.find(".imglink ").attr("href"));m.on("click","a.imglink,.detail-title a",function(a){var b,c,d,e=a.delegateTarget,f=this.href,g=e.getAttribute("data-pos"),h=window.location.href,i=localStorage,j=JSON.parse(i.getItem("statisticsData")),k=j.click_data.search,l=0,m=k.length;if(-1!==h.indexOf("&t=h"))for(;m>l;l++)b=k[l],b.query===r&&"pc_hotQueries"===b.from&&(c=b.click,d={url:f,pos:g},c.push(d));else for(;m>l;l++)b=k[l],b.query===r&&(c=b.click,d={url:f,pos:g},c.push(d));i.setItem("statisticsData",JSON.stringify(j))})}function d(a){if(null==a)return!0;for(var b in a)return!1;return!0}function j(a){document.querySelector(".rectangle-bounce").style.display=a}function k(){if(d(C))return void j("none");var a,b,c,e,f,g,h,i,k,l,m=document.getElementById("goodthing-list"),n=m.querySelector(".goodthing"),o=document.createDocumentFragment(),p=(H.gift_tag_index,0);for(a in C){if(!a||isNaN(a)||p++>=8)break;g=n.cloneNode(!0),h=g.querySelector("a"),i=h.querySelector(".img-container img"),k=h.querySelector(".goodthing-highlight h2 div"),l=h.querySelector(".icon-list .f-l span"),everyMeta=C[a],everyMeta&&(b=everyMeta.cover_image_url,c=everyMeta.rendered_title,f=everyMeta.price,everyMeta.has_buylink&&null!=f&&"N/A"!==f||(f="&nbsp"),e=everyMeta.url,e&&(match=e.match(s),match&&match.length?e=match[0].replace(s,u):(match=e.match(t),match&&match.length&&(e=match[0].replace(t,u)))),b&&-1==b.indexOf("http")&&(b="http://a.diaox2.com/cms/sites/default/files/"+b),h.url=e,i.src=b,i.alt=c,k.innerHTML=c,l.innerHTML=f,o.appendChild(g)),delete C[a]}m.appendChild(o)}function l(a,b,c){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},c)}function m(a,b,c){var d=a["on"+b];a["on"+b]=d?function(){d(),c()}:c}var n,o=$.getParam(),p=document.querySelector(".hot-search-word-list"),q=$(p),r=$.getParam().q,s=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,t=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,u="article/$1.html",o=$.getParam(),v=-1!==r.indexOf("礼物"),w=function(a,b){return a.sort(function(){return Math.random()-.5}),a.slice(0,b)};if(o&&o.q&&(document.title=o.q+"_"+document.title,$("#search-input").val(o.q)),v){$(".hot-search").hide(),$(".present-area").css("display","block"),$.ajax({url:"http://s.diaox2.com/view/app/gift_supply.php",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb4",cache:!0,timeout:1e5,success:h});var x,y,z,A,B={};$(document).on("click",".present-type li",function(){l(a,this,300)})}else $(".hot-search").show(),$(".present-area").css("display","none"),$.ajax({url:"http://api.diaox2.com/v2/app/config",dataType:"jsonp",type:"GET",jsonp:"cb",jsonpCallback:"cb3",success:function(a){n=a.res.search.hot_slide_search_word,n=w(n,5),$.each(n,function(a,b){$('<li class="hot-search-word f-l"><a href="'+window.location.href.split("?")[0]+"?q="+b+'&t=h">'+b+"</a></li>").appendTo(q)})}}),$.ajax({url:"http://s.diaox2.com/ddsearch/q",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb2",cache:!0,timeout:2e4,data:{data:JSON.stringify({query:r,from:"pc"})},success:i});Array.prototype.unique=function(){for(var a={},b=[],c=0,d=this.length;d>c;c++)a[this[c]]||(a[this[c]]=!0,b.push(this[c]));return b},Array.prototype.forEach||(Array.prototype.forEach=function(){}),Array.prototype.reduce||(Array.prototype.reduce=function(){});var C;$.ajax({url:"http://c.diaox2.com/cms/diaodiao/pcsite/zk_feed_list.json",type:"GET",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb",timeout:2e4,success:function(a){var b,c,d=a.goodthing_feed_list,c=[];$.each(d,function(a,d){if(!(a>1)){b=d.url,match=b.match(s),match&&match.length?b=match[0].replace(s,u):(match=b.match(t),match&&match.length&&(b=match[0].replace(t,u)));var e=d.title,f=0,g=d.title.length,h=titleStr2="";if(2===g)h=e[0],titleStr2=e[1];else{for(;g-1>f;f++)h=h+e[f]+"<br>";titleStr2=e[g-1]}c.push('<li class="loading"><a target="_blank" href="',b,'"><img src="',d.cover_image_url,'" alt="',h.replace("<br>",""),'" width="277" height="180"><p>',h,"</p><span>",titleStr2,'</span><div class="black-musk"></div></a></li>')}}),document.getElementById("special").innerHTML=c.join("")}});var D,E=window.location.href,F=localStorage,G=F.getItem("statisticsData"),H=G?JSON.parse(G):{};G||(H.method="log_search_click",H.click_data={did:"",search:[]}),D=-1!==E.indexOf("&t=h")?"pc_hotQueries":"pc_searchResult";var I=H.click_data.search,J={query:r,from:D,click:[]};I.push(J),F.setItem("statisticsData",JSON.stringify(H));F.getItem("statisticsData");document.getElementById("search-input").value=document.getElementById("search-input").value.replace(/\+/g," "),v&&m(window,"scroll",function(){if(document.querySelector(".goodthing")){var a=document.body.clientHeight,b=document.documentElement.offsetHeight,c=document.documentElement.scrollTop||document.body.scrollTop;c+b===a&&(l(k,window,700),j("block"))}})});