/*! diaodiao 李彦峰 2015-10-21 */
$.extend({getParam:function(){var a,b,c,d,e,f=window.location.href,g=f.split("?"),h={},i=0;if(g.length>1&&(c=g[1]),c)for(a=c.split("&"),b=a.length;b>i;i++)d=a[i],e=d.split("="),h[e[0]]=decodeURIComponent(e[1]);return h}}),$(function(){function a(){var a=b(),c=t.meta_infos,d=[];console.log(a),a&&a.length&&a.forEach(function(a){d.push(c[a])})}function b(){console.time("intersect");var a,b,c=$(".scene .cur-select,.relation .cur-select,.character .cur-select"),e=$(".price .cur-select"),f=[],g=[],h=[],i=[],j=[],k=[];return c.each(function(a,b){"character"===b.getAttribute("data-group")?g.push(b.getAttribute("data-title")):h.push(b.getAttribute("data-title"))}),g.length&&(i=[],g.forEach(function(a){i.push(u[a])}),j.push(i.reduce(function(a,b){return a.concat(b)}).unique())),e.length&&e.each(function(a,b){f.push(b.getAttribute("data-title"))}),f.length&&(a=d(f),j.push(a)),h.forEach(function(a){j.push(u[a])}),j.length&&(b=j.reduce(function(a,b){return k.length=0,a.forEach(function(a){b.forEach(function(b){a===b&&k.push(a)})}),k})),console.timeEnd("intersect"),b}function c(a){if(null==a)return!0;for(var b in a)return!1;return!0}function d(a){console.time("getAidsByPrice");var b,d,e,f,g,h=/\d+(\.\d+)?/g,i=[],j=t.meta_infos;return a.forEach(function(a){!c(cacheForPrice)&&a in cacheForPrice&&i.concat(cacheForPrice[a]),cacheResult.length=0,b=a.split("-");for(e in j)e=+e,f=j[e],d=f.has_buylink,g=f.price,d&&g&&(g=g.match(h),g&&g.length&&(g=parseFloat(g[0])),g>=b[0]&&(b[1]?g<b[1]&&-1===i.indexOf(e)&&i.push(e):-1===i.indexOf(e)&&i.push(e)))}),console.log(cacheForPrice),console.timeEnd("getAidsByPrice"),i}function e(a){t=a;var b=a.gift_tag_index;$.extend(u,b.scene,b.relation,b.character),"礼物"!==k}function f(a){if(console.log("查询接口的jsonp执行成功！！"),a.count>0){var b,c,d,e,f,g,h,i=a.aids,j=a.meta_infos,o="",p=$(".result-list");$.each(i,function(a,i){b=j[i],e=o="",b.price||(b.price="<img width='15' height='15' style='margin-right:5px;' src='http://c.diaox2.com/cms/diaodiao/assets/links.png'>全网结果"),c=b.rendered_keywords,$.each(c,function(a,b){o+=0==a&&b[0]==k?'<li class="f-l"><span class="target-word">'+b[0]+"</span></li>":'<li class="f-l">'+b[0]+"</li>"}),d=b.rendered_title,h=b.thumb_image_url,-1==h.indexOf("http")&&(h="http://a.diaox2.com/cms/sites/default/files/"+h),e=b.author.src||b.author.url,-1==e.indexOf("http")&&(e="editor/"+e+".html"),d=d.replace(/<<<<(.*?)>>>>/gi,"<span class='target-word'>$1</span>"),f=b.url,g=f.match(l),g&&g.length?f=g[0].replace(l,n):(g=f.match(m),g&&g.length&&(f=g[0].replace(m,n)));var q=b.price;(b.has_buylink===!1||"N/A"===b.price)&&(q="&nbsp"),$('<li class="result-item" data-pos='+(a+1)+'><a target="_blank" href="http://www.diaox2.com/'+f+'" class="imglink f-l"><div class="result-item-img-container loading"><img src="'+h+'" alt="'+c+'" width="188" height="188"></div></a><div class="result-item-detail f-l"><h2 class="detail-title"><a target="_blank" href="'+f+'">'+d+'</a></h2><ul class="detail-keywords clearfix">'+o+'</ul><div class="detail-author clearfix"><a class="detail f-l">'+q+'</a><div class="author f-l clearfix"><ul class="clearfix"><li class="author-face f-l"><a target="_blank" href="'+e+'"><span class="author-face-container"><img src="http://c.diaox2.com/cms/diaodiao/'+b.author.pic+'" width="20" height="20"></span></a></li><li class="author-name f-l"><a target="_blank" href="'+e+'">'+b.author.name+"</a></li></ul></div></div></div></li>").appendTo(p)})}else $(".no-result").find(".target-word").html("“"+(void 0==k?"":k)+"”"),$(".no-result").addClass("disblk");var q=$(".result-item"),f=(q.attr("data-pos"),q.find(".imglink ").attr("href"));q.on("click","a.imglink,.detail-title a",function(a){var b=a.delegateTarget,c=this.href,d=b.getAttribute("data-pos"),e=window.location.href,f=localStorage,g=JSON.parse(f.getItem("statisticsData")),h=g.click_data.search,i=0,j=h.length;if(-1!==e.indexOf("&t=h"))for(;j>i;i++){var l=h[i];if(l.query===k&&"pc_hotQueries"===l.from){var m=l.click,n={url:c,pos:d};m.push(n)}}else for(;j>i;i++){var l=h[i];if(l.query===k){var m=l.click,n={url:c,pos:d};m.push(n)}}f.setItem("statisticsData",JSON.stringify(g))})}var g,h=$.getParam(),i=document.querySelector(".hot-search-word-list"),j=$(i),k=$.getParam().q,l=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,m=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,n="article/$1.html",h=$.getParam(),o=-1!==k.indexOf("礼物"),p=function(a,b){return a.sort(function(){return Math.random()-.5}),a.slice(0,b)};if(h&&h.q&&(document.title=h.q+"_"+document.title,$("#search-input").val(h.q)),o){$(".hot-search").hide(),$(".present-area").css("display","block"),$.ajax({url:"http://s.diaox2.com/view/app/gift_supply.php",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb4",cache:!0,timeout:8e4,error:function(a){console.log("搜索接口的jsonp执行失败！！ "+a)},success:e});var q,r,s,t,u={};$(document).on("click",".present-type li",function(){s=$(this);var b=this.getAttribute("data-group");if("scene"===b){if(q&&(q.removeClass("cur-select"),q.attr("data-title")===s.attr("data-title")))return q=void 0,void a();s.addClass("cur-select"),q=s}else if("relation"===b){if(r&&(r.removeClass("cur-select"),r.attr("data-title")===s.attr("data-title")))return r=void 0,void a();s.addClass("cur-select"),r=s}else("character"===b||"price"===b)&&s.toggleClass("cur-select");a()})}else $(".hot-search").show(),$(".present-area").css("display","none"),$.ajax({url:"http://api.diaox2.com/v2/app/config",dataType:"jsonp",type:"GET",jsonp:"cb",jsonpCallback:"cb3",error:function(a){console.log("热搜词接口的jsonp执行失败！！"),console.log(a)},success:function(a){console.log("热搜词接口的jsonp执行成功！！"),g=a.res.search.hot_slide_search_word,g=p(g,5),$.each(g,function(a,b){$('<li class="hot-search-word f-l"><a href="'+window.location.href.split("?")[0]+"?q="+b+'&t=h">'+b+"</a></li>").appendTo(j)})}}),$.ajax({url:"http://s.diaox2.com/ddsearch/q",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb2",cache:!0,timeout:2e4,data:{data:JSON.stringify({query:k,from:"pc"})},error:function(a){console.log("搜索接口的jsonp执行失败！！ "+a)},success:f});Array.prototype.unique=function(){for(var a={},b=[],c=0,d=this.length;d>c;c++)a[this[c]]||(a[this[c]]=!0,b.push(this[c]));return b},Array.prototype.forEach||(Array.prototype.forEach=function(){}),Array.prototype.reduce||(Array.prototype.reduce=function(){}),$.ajax({url:"http://c.diaox2.com/cms/diaodiao/pcsite/zk_feed_list.json",type:"GET",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb",timeout:2e4,error:function(a){console.log("获取热门专题接口的jsonp执行失败！！"),console.log(a)},success:function(a){console.log("获取热门专题接口的jsonp执行成功！！");var b,c=a.goodthing_feed_list,d=$(".special");$.each(c,function(a,c){if(!(a>1)){b=c.url,match=b.match(l),match&&match.length?b=match[0].replace(l,n):(match=b.match(m),match&&match.length&&(b=match[0].replace(m,n)));var e=c.title,f=0,g=c.title.length,h=titleStr2="";if(2===g)h=e[0],titleStr2=e[1];else{for(;g-1>f;f++)h=h+e[f]+"<br>";titleStr2=e[g-1]}$('<li class="loading"><a target="_blank" href="'+b+'"><img src="'+c.cover_image_url+'" alt="'+h.replace("<br>","")+'" width="277" height="180"><p>'+h+"</p><span>"+titleStr2+'</span><div class="black-musk"></div></a></li>').appendTo(d)}})}});var v,w=window.location.href,x=localStorage,y=x.getItem("statisticsData"),z=y?JSON.parse(y):{};y||(z.method="log_search_click",z.click_data={did:"",search:[]}),v=-1!==w.indexOf("&t=h")?"pc_hotQueries":"pc_searchResult";var A=z.click_data.search,B={query:k,from:v,click:[]};A.push(B),x.setItem("statisticsData",JSON.stringify(z));x.getItem("statisticsData");document.getElementById("search-input").value=document.getElementById("search-input").value.replace(/\+/g," ")});