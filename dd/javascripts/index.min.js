/*! diaodiao 李彦峰 2016-11-10 */
$(function(){function a(a){var b,c=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,d=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,e="http://www.diaox2.com/article/$1.html";return a?(b=a.match(c),b&&b.length?a=b[0].replace(c,e):(b=a.match(d),b&&b.length&&(a=b[0].replace(d,e))),a):a}function b(a,b){var c="";if(a){var d=0,e=a.length;if(1===e)c=a[0];else if(3==b)for(;e-1>d;)c+=a[d++];else for(;e>d;)c+=a[d++]}return c}function c(a,b,c){var d,e,f,g,h=arguments.length,i=!1;0===h||h>3||(1===h?(d=arguments[0],a=d.method,b=d.context||this,c=d.interval,"boolean"==typeof i&&(i=d.firstDelay)):2===h&&(c=b,b=this),i?(clearTimeout(b.__throttle_timer__),b.__throttle_timer__=setTimeout(function(){a.call(b)},c)):(e=b.__throttle_count__,e||(e=b.__throttle_count__=0,b.startTime=+new Date,a.call(b)),e>=1&&(f=b.startTime,g=+new Date,b.startTime=g,g-f>c&&a.call(b)),b.__throttle_count__++))}function d(a){var b=document.createElement("b");return b.innerHTML="<!--[if IE "+a+"]><i></i><![end if]-->",1===b.getElementsByTagName("i").length}var e=function(a){this.bannerArea=a.container,this.distance=a.width,this.bannerList=this.bannerArea.find(".banner-list"),this.list=$.makeArray(this.bannerList.children()),this.autoPlay=!0,this.hoverPausePlay=!0,this.direction=a.direction||"leftToRight","boolean"==typeof a.autoPlay&&(this.autoPlay=a.autoPlay),"boolean"==typeof a.hoverPausePlay&&(this.hoverPausePlay=a.hoverPausePlay),this.start()};e.prototype={constructor:e,bindEvent:function(){var a=this,b=a.distance,d=$(a.bannerList);a.bannerArea.on("click",".next",function(){c(function(){var c=parseInt(d.css("left"));d.animate({left:c-b},function(){var b=a.list.shift();a.list.push(b),$(b).remove(),d.append(b),d.css("left",0)})},this,700)}),a.bannerArea.on("click",".prev",function(){c(function(){var c=(parseInt(d.css("left")),a.list.pop());a.list.unshift(c),$(c).remove(),$(a.list[1]).before(c),d.css("left",-b),d.animate({left:0})},this,700)}),this.hoverPausePlay&&$(".banner-container,.prev,.next").hover(function(){a.stopPlay()},function(){a.play()})},start:function(){this.autoPlay&&this.play(),this.bindEvent()},stopPlay:function(){clearInterval(this.timer)},play:function(){var a=this;a.timer=setInterval(function(){"leftToRight"===a.direction?a.bannerArea.find(".next").trigger("click"):a.bannerArea.find(".prev").trigger("click")},2e3)}},d(6)||d(7)||d(8)||d(9)?document.getElementById("wrapper").removeChild(document.getElementById("banner-area")):$.ajax({url:"http://api.diaox2.com/v4/meta",timeout:2e4,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({is_grey:!1,request_methods:["feed_order_data"]})}).done(function(c){var d=c.res.feed_order_data.carousel;$.ajax({url:"http://api.diaox2.com/v4/meta",timeout:2e4,type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({is_grey:!1,request_methods:["specified_meta_data"],request_data:{specified_meta_data:{cids:d}}})}).done(function(c){for(var d=c.res.specified_meta_data.meta_infos,f=document.getElementById("banner-list"),g=[],h=0,i=d.length;i>h;h++){var j=d[h];g.push('<li data-index="',h,'"><a href="',a(j.url),'" target="_blank"><img src="',j.banner,'" alt="" width="490" height="317"><div><p>',b(j.title,j.ctype),"</p></div></a></li>")}f.innerHTML=g.join("");var f=$(f),k=f.find("li"),l=k.css("margin-right"),m=k.width()+parseInt(l);f.css("width",h*m),new e({container:$(".banner-area"),width:m,direction:"leftToRight",autoPlay:!0,hoverPausePlay:!0})}).error(function(a,b,c){console.log(a),console.log(b),console.log(c)})}).error(function(a,b,c){console.log(a),console.log(b),console.log(c)});var f=$("#wrapper"),g=f.find(".top-header"),h=g.height(),i=f.find(".header"),j=f.find(".banner-area");window.onscroll=function(){var a=document.body.scrollTop||document.documentElement.scrollTop;a>=h?(i.addClass("fixed"),j.css("margin-top",50)):(i.removeClass("fixed"),j.css("margin-top",0))};var k=function(a){this.countPerPage=a.countPerPage,this.totalCount=a.totalCount,this.cut=a.cut||4,this.displayPageCount=a.displayPageCount||7,this.appendTo=a.appendTo,this.data=a.data,this.currentIndex=1,this.oldCurrentIndex=1,this.state=1,this.callback=a.callback,null==this.totalCount&&this.data&&this.data.length>0&&(this.totalCount=this.data.length),this.pageCount=Math.ceil(this.totalCount/this.countPerPage),this.start()};k.prototype={constructor:k,renderDOM:function(){var a=document.getElementById("pagination-main"),b=document.createDocumentFragment(),c=this.pageCount;if(!(1>=c)){var d=function(a){return a.href="javascript:void(0);",a.onclick="return false;",a},e=d(document.createElement("a")),f=e.cloneNode(!1);if(e.className="pagination-previous",e.innerHTML="上一页",f.className="pagination-next",f.innerHTML="下一页",b.appendChild(e),c<=this.displayPageCount)for(var g=0;c>g;g++){var h=d(document.createElement("a"));h.innerHTML=g+1,h.className="item",h.title=g+1,b.appendChild(h)}else{for(var g=0;g<this.displayPageCount-1;g++){var h=d(document.createElement("a"));h.innerHTML=g+1,h.className="item",h.title=g+1,b.appendChild(h)}var i=d(document.createElement("a"));i.innerHTML="...",i.className="more",b.appendChild(i);var j=d(document.createElement("a"));j.innerHTML=c,j.className="item",j.title=c,b.appendChild(j)}b.appendChild(f),a.appendChild(b),this.current()}},getStateByPageNum:function(a){return a<=this.cut?1:a>this.cut&&a<this.pageCount-this.cut+1?2:a>=this.pageCount-this.cut+1&&a<=this.pageCount?3:void 0},calcState:function(a,b){a=a||this.currentIndex,this.state=this.getStateByPageNum(a),this.oldCurrentIndex=b},current:function(a){var b=this.appendTo.querySelector(".current");b&&(b.className="item"),a=a||this.currentIndex;var c=this.appendTo.querySelector('.item[title="'+a+'"]');c&&(c.className=c.className+" current"),this.currentIndex=a,this.calcState(a,null==b?1:b.title)},sliceData:function(a){a=a||this.currentIndex;var b=(a-1)*this.countPerPage,c=a*this.countPerPage;return this.data.slice(b,c)},toTop:function(){var a=this;$("html,body").animate({scrollTop:a.appendTo.offsetTop-80},"slow")},changeDOM:function(a){console.log("changeDOM exec..."),this.updatePaginationBar(),this.callback.call(this,a),this.toTop()},clearPaginationBar:function(){document.getElementById("pagination-main").innerHTML=""},stateOneUpdateDOM:function(){this.clearPaginationBar(),this.renderDOM(),console.log("state 1 updateDOM")},stateTwoUpdateDOM:function(){this.clearPaginationBar();var a=document.getElementById("pagination-main"),b=document.createDocumentFragment(),c=this.pageCount;if(!(1>=c)){var d=function(a){return a.href="javascript:void(0);",a.onclick="return false;",a},e=d(document.createElement("a")),f=e.cloneNode(!1);e.className="pagination-previous",e.innerHTML="上一页",f.className="pagination-next",f.innerHTML="下一页",b.appendChild(e);var g=d(document.createElement("a"));g.innerHTML=g.title=1,g.className="item",b.appendChild(g);var h=g.cloneNode(!1);h.innerHTML="...",h.className="more",b.appendChild(h);for(var i=this.currentIndex-2;i<=+this.currentIndex+2;i++){var j=g.cloneNode(!1);j.innerHTML=j.title=i,b.appendChild(j)}b.appendChild(h.cloneNode(!0));var k=g.cloneNode(!1);k.innerHTML=k.title=this.pageCount,k.className="item",b.appendChild(k),b.appendChild(f),a.appendChild(b),this.current()}},stateThreeUpdateDOM:function(){this.clearPaginationBar();var a=document.getElementById("pagination-main"),b=document.createDocumentFragment(),c=this.pageCount;if(!(1>=c)){var d=function(a){return a.href="javascript:void(0);",a.onclick="return false;",a},e=d(document.createElement("a")),f=e.cloneNode(!1);e.className="pagination-previous",e.innerHTML="上一页",f.className="pagination-next",f.innerHTML="下一页",b.appendChild(e);var g=d(document.createElement("a"));g.innerHTML=g.title=1,g.className="item",b.appendChild(g);var h=g.cloneNode(!1);h.innerHTML="...",h.className="more",b.appendChild(h);for(var i=c-this.displayPageCount+2;c>=i;i++){var j=g.cloneNode(!1);j.innerHTML=j.title=i,b.appendChild(j)}b.appendChild(f),a.appendChild(b),this.current(),console.log("state 3 updateDOM")}},updatePaginationBar:function(){this.currentIndex;if(!(this.pageCount<=this.displayPageCount)){var a=this.getStateByPageNum(this.oldCurrentIndex),b=this.getStateByPageNum(this.currentIndex);if(1===b){if(console.log("old state:"+a+" change to new state:"+b),b===a)return;this.stateOneUpdateDOM()}else if(2===b)console.log("old state:"+a+" change to new state:"+b),this.stateTwoUpdateDOM();else if(3===b){if(console.log("old state:"+a+" change to new state:"+b),b===a)return;this.stateThreeUpdateDOM()}}},bindEvent:function(){var a=this;this.appendTo.onclick=function(b){b=b||event;var c=b.target||b.srcElement;if("pagination-previous"===c.className){var d=a.currentIndex;1!=d&&(a.currentIndex--,a.current(),a.changeDOM(a.sliceData()))}else if("pagination-next"===c.className){var d=a.currentIndex;d!=a.pageCount&&(a.currentIndex++,a.current(),a.changeDOM(a.sliceData()))}else if(-1!==c.className.indexOf("item")){if(-1!==c.className.indexOf("current"))return;a.current(c.title),a.changeDOM(a.sliceData())}}},start:function(){this.renderDOM(),this.bindEvent()}},$.ajax({url:"http://c.diaox2.com/cms/diaodiao/pcsite/goodthing_feed_list.json",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb",success:function(c){{var d,e,f,g=c.goodthing_feed_list,h=document.getElementById("content-list"),i=document.createDocumentFragment(),j=0;g.length}console.log(c);for(var l=24;l>j;)if(d=g[j++],null!=d){e=a(d.url),f=document.createElement("li");var m="",n='width="390" height="254"';1==d.ctype&&(m='onload="adjust(this);"',n=""),f.innerHTML='<a href="'+e+'" target="_blank"><dl><dt class="loading"><div class="img-container"><img '+m+' src="'+d.cover_image_url+'" '+n+"></div></dt><dd><h3><p>"+b(d.title,d.ctype)+'</p></h3><div class="icon-list clearfix"><img class="icon-author" width="30" height="30" src="http://c.diaox2.com/cms/diaodiao/'+d.author.pic+'"></div></dd></dl></a>',i.appendChild(f)}h.appendChild(i);new k({countPerPage:l,data:g,displayPageCount:7,appendTo:document.getElementById("content-area"),callback:function(c){function d(c,d){var e=c.getElementsByTagName("a")[0],f=e.querySelector(".img-container"),g=f.getElementsByTagName("img")[0],h=e.querySelector("h3 p"),i=e.querySelector(".icon-author");c.style.display="block",e.href=a(d.url),1==d.ctype?(g.removeAttribute("width"),g.removeAttribute("height"),g.onload=function(){adjust(this)}):g.onload&&(g.width=f.offsetWidth,g.height=f.offsetHeight,g.removeAttribute("onload"),g.removeAttribute("style")),g.src=d.cover_image_url,h.innerHTML=b(d.title,d.ctype),i.src="http://c.diaox2.com/cms/diaodiao/"+d.author.pic}var e=document.getElementById("content-list"),f=e.children;if(!-[1]){var g=f;f=[];for(var h=0,i=g.length;i>h;h++)1==g[h].nodeType&&f.push(g[h])}var i=f.length,h=0;if(i===c.length)for(;i>h;h++)d(f[h],c[h]);else for(;i>h;h++){var j=f[h];h<c.length?d(j,c[h]):j&&(j.style.display="none")}}})}})});