/*! diaodiao 李彦峰 2016-10-09 */
function getlongid(){var a=$("body").attr("id");if(void 0==a){var b=window.location.href.match(/\?[ac]?id=(\d+)/i);if(void 0==b)return console.log("No serverid found! Can't get comment"),a=-1;a=Number(b[1]),4294967296>a&&(a=4294967296*a+a)}return a}function getshortid(){var a=$("body").attr("id");if(void 0==a){var b=window.location.href.match(/\?[ac]?id=(\d+)/i);if(void 0==b)return console.log("No serverid found! Can't get comment"),a=-1;a=b[1]}return 65535&a}function get_access(a,b,c,d){var e="http://api.diaox2.com/v1/contvote",f=0;if(void 0==a)return!1;void 0==b&&(b="span.cardread"),void 0==c&&(c=get_access_succeed(b)),void 0==d&&(d=get_access_fail(b)),jQuery.support.cors=!0;var g={method:"get",cids:[]};a.length<=100?(g.cids=a,f=a.length):(g.cids=a.slice(0,100),f=100);var h="";return h=$.toJSON(g),$.ajax({type:"POST",contentType:"application/json",data:h,dataType:"json",url:e,success:c,timeout:api_ajax_timeout,error:d}),console.log("Sent "+f+" ids at this time!"),f}function add_access(a,b,c,d){var e=window.location.href,f="";f=-1!=e.indexOf("?")?e.substring(0,e.indexOf("?")):e;var g=$("body").attr("id"),h=$("body").attr("data-type"),i="";i=void 0==g?"http://api.diaox2.com/v1/contvote":"http://api.diaox2.com/v1/contvote/"+g;var j="";if(void 0==b?b="access":console.log("method is: "+b),void 0!=a)a.method=b,a.url=f;else var a={method:"access",url:f,action:"none",value:"none"};if(a.self=e,a.referer=document.referrer,a.type=h,a.isIOS=navigator.userAgent.match(/iphone|ipod|ios|ipad/i)?"true":"false",-1!=e.indexOf("?from=timeline")?(a.wechat=1,a.timeline=1):-1!=e.indexOf("?from=groupmessage")?(a.wechat=1,a.groupmessage=1):-1!=e.indexOf("?from=singlemessage")&&(a.wechat=1,a.singlemessage=1),-1!=e.indexOf("&isappinstalled=0")?a.installed=0:-1!=e.indexOf("&isappinstalled=1")&&(a.installed=1),navigator.userAgent.match(/MicroMessenger/i)&&(a.wechat=1),navigator.userAgent.match(/weibo/i)&&(a.weibo=1),j=$.toJSON(a),void 0==c)var c=add_access_succeed(j);if(void 0==d)var d=add_access_fail(j);return jQuery.support.cors=!0,$.ajax({type:"POST",contentType:"application/json",data:j,dataType:"json",url:i,success:c,timeout:api_ajax_timeout,error:d}),console.log("Sent add access: "+j),!0}function bind_log_click(a,b,c){void 0==a&&(a=".relcard"),void 0==b&&(b="data-href"),void 0==c&&(c=1),$(a).unbind("click"),$(a).bind("click",function(a){a.stopPropagation();var d=$(this).attr(b);(void 0==d||0==d.length)&&(d="#"),console.log("Click on "+a.toElement.tagName+" with target "+d);var e=a.toElement.className;return(void 0==e||0==e.length)&&(e="NONE"),$(this).toggleClass("sel"),console.log("clicked!"),add_access({target:d,clickon:a.toElement.tagName,"class":e,action:"click",value:c},"log",succ_click(this,d),fail_click(this,d)),!0})}function initHot(a,b,c,d,e){if(jQuery.support.cors=!0,void 0==a)a="div#relcardlast";else if(0==$(a).length||b&&0>=b)return;(void 0==b||isNaN(b))&&(b=5),void 0==c&&(c="cms/diaodiao/articles/dynamic");var f=window.location.href,g=/^(?:https?:\/\/)?([^\/]+)\//,h=g.exec(f),i="http://c.diaox2.com/";void 0!=h&&(i=h[0]),c="/view/app/?m=recommend&id=";var j=i+c+getshortid();return $.ajax({type:"GET",contentType:"application/x-www-form-urlencoded",dataType:"JSON",url:j,success:add_hot_success(a,b,d),timeout:api_ajax_timeout,error:add_hot_fail(a,b,c,d,e)}),!0}function update_read(a,b){void 0==a&&(a="span.cardread");for(var c=$(a),d=[],e=0;e<c.length;e++)isNaN($(c[e]).attr("data-id"))||d.push(Number($(c[e]).attr("data-id")));return timely_update_read=function(c){ofunc=function(){var d=c.slice(0,100);return c=c.slice(100),d.length>0?(get_access(d,a),void setTimeout(ofunc,2e3)):(console.log("timer is off, callback time"),void 0!=b&&b(a),!0)},ofunc()},timely_update_read(d),!0}function gen_pic_info(a,b,c){function d(){var a=$(this).attr("id");return a.length?(e.current=a,console.log(e),ddPicBrowserMode(e,exit_pic_browser)):console.log("There is no id for '"+this+"'"),!0}void 0==a&&(a="div.content img"),void 0==b||"object"!=typeof b?b={"/cms/diaodiao/assets/cart.png":"1"}:b["/cms/diaodiao/assets/cart.png"]="1",void 0==c||"object"!=typeof c?c={"/cms/diaodiao/assets/pixel.gif":"1","http://c.diaox2.com/cms/diaodiao/assets/pixel.gif":"1","http://a.diaox2.com/cms/diaodiao/assets/pixel.gif":"1"}:(c["/cms/diaodiao/assets/pixel.gif"]="1",c["http://c.diaox2.com/cms/diaodiao/assets/pixel.gif"]="1",c["http://a.diaox2.com/cms/diaodiao/assets/pixel.gif"]="1");var e={urls:[]},f=$(a),g=0,h="contentimg";for(g=0;g<f.length;g++){var i=$(f[g]).attr("src");if(i in c&&(i=$(f[g]).attr("data-src")),i in b)f.splice(g,1),g--;else if(".gif"!=i.substr(-4).toLowerCase()){var j=h+g;$(f[g]).attr("id",j),e.urls.push({url:i,id:j})}else f.splice(g,1),g--}for(console.log("gen_pic_info: gen json ok"),g=0;g<f.length;g++)$(f[g]).bind("click",d);return console.log("gen_pic_info: bind ok."),!0}function aa(a,b,c){return console.log("获取统计数据失败"),console.log(c),console.log("response: "+a.responseText),void 0!=target?$(target).text("..."):$("span#cmt_num").text("..."),!0}function get_article_status(a,b,c){var d=$("body").attr("id");if(void 0==d){var e=window.location.href.match(/\?[ac]?id=(\d+)/i);if(void 0==e)return console.log("No serverid found! Can't get comment"),!1;d=e[1]}var f={aids:a},g=JSON.stringify(f);return jQuery.support.cors=!0,$.ajax({type:"POST",contentType:"application/json",data:g,dataType:"json",url:"http://api.diaox2.com/v1/stat/all",success:b,timeout:5e3,error:c}),console.log("request sent : "+g),!0}var api_ajax_timeout=8e3,get_access_succeed=function(a){return void 0==a&&(a="span.cardread"),function(b){if("undefined"==typeof b)return console.log("get_access succeeded but no data receive!"),!1;if(console.log("get_access_succeed: print data -> "),console.log(b),"SUCCESS"!=b.result)return console.log("get_access invoked but server fail."),!1;var c=$(a);for(var d in b.vote_status){for(var e=0;e<c.length;e++)d==$(c[e]).attr("data-id")&&$(c[e]).text("阅读 "+b.vote_status[d].access);console.log("Id["+d+"] has access:"+b.vote_status[d].access)}return console.log("selector in closure is : "),console.log(a),!0}},get_access_fail=function(a){return void 0==a&&(a="span.cardread"),function(b,c,d){return console.log("get_access failed, with error "+d),console.log("update "+a+" to 阅读 ...?"),!0}},add_access_succeed=function(a){return function(b){return"undefined"==typeof b?(console.log("add_access succeeded but no data receive!"),!1):(console.log("access_succeed: print data -> "),console.log(b),"SUCCESS"!=b.result?(console.log("add_access invoked but server fail."),!1):(console.log(-1!=a.indexOf('"method": "access"')?"Now this article is read "+b.vote_status.access+" times.":"Now action logged!"),console.log("postdata in closure is : "),console.log(a),!0))}},add_access_fail=function(a){return function(b,c,d){return console.log("add_access failed, with error "+d),console.log("postdata in closure is : "),console.log(a),!0}},succ_click=function(a,b){return void 0==b&&(b="NONE"),function(c){return $(a).toggleClass("sel"),console.log("click call with extra "+b+" succeeded with data"),console.log(c),window.open(b,"","resizable=no,alwaysRaised=yes,depended=yes,location=no,menubar=no"),!0}},fail_click=function(a,b){return void 0==b&&(b="NONE"),function(c,d,e){return $(a).toggleClass("sel"),console.log("click call with extra "+b+" failed with error "+e),window.open(b,"","resizable=no,alwaysRaised=yes,depended=yes,location=no,menubar=no"),!0}},relwidth=-1,relheight=-1,add_hot_success=function(a,b,c){if(void 0==a&&(a="div#relcardlast"),(void 0==b||isNaN(b))&&(b=5),void 0==relwidth||-1==relwidth||void 0==relheight||-1==relheight){var d=$('<div class="half"><div class="relcard"></div></div><div class="half"><div class="relcard"></div></div>').insertBefore(a);relwidth=$(".relcard").width(),relheight=Math.ceil(relwidth/596*486),d.remove()}return function(d){var e=0,f=new Array,g=$("div.relcard > a[href]"),h=0,i="";for(h=window.location.href.indexOf("#diaodiao"),i=-1==h?window.location.href:window.location.href.slice(0,h),h=i.indexOf(".html?"),-1==h?console.log("No op on url"):i=i.slice(0,h)+".html",f[i]=1,e=0;e<g.length;e++)i=$(g[e]).attr("href"),f[i]=1;e=0;for(var j=0,k="";b>e&&j<d.length;)if(h=Math.floor(Math.random()*d.length),d[h].url in f||""==d[h].thumb||""==d[h].title||""==d[h].total)j++,d.splice(h,1);else{window.location.href.match(/\/share(?:test)?\/\d+\.html/i)&&(d[h].url="http://"+window.location.host+"/share/"+d[h].serverid+".html"),d[h].title=d[h].title.replace(/[ \t]{2,}/g," "),k+='<div class="half">',k+='<div class="relcard" data-href="'+d[h].url+'" data-type="'+d[h].type+'">\n';var l='style="width:'+relwidth+"px; height:"+relheight+'px;"',m='style="width:'+relwidth+"px;";k+='<div class="relimage"'+l+">";var n;n=d[h].cover,m+="position:relative;",m+="firstpage"==d[h].type?"top:-"+Math.floor(80*relwidth/322)+'px;"':'"',k+='<img src="/cms/diaodiao/assets/pixel.gif" data-src="'+n+'" '+m+"/></div>",k+='<div class="relmask"></div>';var o=d[h].title.length>26?d[h].title.slice(0,24)+"...":d[h].title;k+='<div class="relcontent"><table><tbody><tr><td class="reltitle">'+o+"</td></tr></tbody></table></div>",k+="</div></div>",f[d[h].url]=1,e++,j++}return $(k).insertBefore(a),$(".relimage > img").lazy({bind:"event",delay:0}),void 0!=c&&c(),!0}},add_hot_fail=function(a,b,c,d,e){return void 0==a&&(a="div#relcardlast"),function(f,g,h){if(console.log("get hot article failed, with error:"),console.log(h),void 0==$(".reload")||0==$(".reload").length){var i='<div class="half"><div class="relcard reload"><div class="relimage" style="';i+='style="width:'+relwidth+"px; height:"+relheight+'px;"',i+='><img src="/cms/diaodiao/people/robot.jpg" /></div><div class="relmask"></div><div class="relcontent"><table><tbody><tr><td class="reltitle">点击重新加载</td><td></td></tr></tbody></table></div></div></div>',$(i).insertBefore(a),$(".reload").bind("click",function(){return $(".reload").remove(),initHot(a,b,c,d,e),!0})}return void 0!=e&&e(),!0}};String.prototype.hashCode=function(){var a,b,c,d=0;if(0==this.length)return d;for(a=0,c=this.length;c>a;a++)b=this.charCodeAt(a),d=(d<<5)-d+b,d|=0;return d};