/*! diaodiao 李彦峰 2017-03-21 */
$.extend({getParam:function(){var a,b,c,d,e,f=window.location.href,g=f.split("?"),h={},i=0;if(g.length>1&&(c=g[1]),c)for(a=c.split("&"),b=a.length;b>i;i++)d=a[i],e=d.split("="),h[e[0]]=decodeURIComponent(e[1]);return h}}),$(function(){function a(){var a=b(),d=t.meta_infos,e=[];a.forEach(function(a){e.push(d[a])}),c(e)}function b(){var a=[],b=$(".scene .cur-select,.relation .cur-select,.character .cur-select");b.each(function(b,c){a.push(c.innerHTML)});var c=[];for(var d in u)c.push(u[d]);var e=[],f=c.reduce(function(a,b){return e.length=0,a.forEach(function(a){b.forEach(function(b){a===b&&e.push(a)})}),e});return console.log(f),f}function c(a){{var b,c,d,e,f,g=$(".goodthing-list");z.gift_tag_index}for(b in a)everyMeta=a[b],c=everyMeta.cover_image_url,d=everyMeta.rendered_title,f=everyMeta.price,(everyMeta.has_buylink===!1||"N/A"===everyMeta.price)&&(f="&nbsp"),e=everyMeta.url,match=e.match(k),match&&match.length?e=match[0].replace(k,m):(match=e.match(l),match&&match.length&&(e=match[0].replace(l,m))),-1==c.indexOf("http")&&(c="http://a.diaox2.com/cms/sites/default/files/"+c),$('<li class="goodthing"><a href="http://www.diaox2.com/'+e+'" target="_blank"><div class="img-container"><img src="'+c+'" alt="'+d+'" onload="adjust(this)"></div><div class="goodthing-highlight"><h2><div>'+d+'</div></h2><ul class="icon-list clearfix"><li class="icon-item f-l"><span>'+f+'</span></li><li class="icon-item f-r"><i class="icon icon-s"></i><span>132</span></li><li class="icon-item f-r"><i class="icon icon-z"></i><span>123</span></li></ul></div></a></li>').appendTo(g)}function d(a){t=a;var b=a.gift_tag_index;console.log(a),$.extend(u,b.scene,b.relation,b.character),console.log(u),"礼物"!==j}function e(a){if(console.log("查询接口的jsonp执行成功！！"),a.count>0){var b,c,d,e,f,g,h,i=a.aids,n=a.meta_infos,o="",p=$(".result-list");$.each(i,function(a,i){b=n[i],e=o="",b.price||(b.price="<img width='15' height='15' style='margin-right:5px;' src='http://c.diaox2.com/cms/diaodiao/assets/links.png'>全网结果"),c=b.rendered_keywords,$.each(c,function(a,b){o+=0==a&&b[0]==j?'<li class="f-l"><span class="target-word">'+b[0]+"</span></li>":'<li class="f-l">'+b[0]+"</li>"}),d=b.rendered_title,h=b.thumb_image_url,-1==h.indexOf("http")&&(h="http://a.diaox2.com/cms/sites/default/files/"+h),e=b.author.src||b.author.url,-1==e.indexOf("http")&&(e="editor/"+e+".html"),d=d.replace(/<<<<(.*?)>>>>/gi,"<span class='target-word'>$1</span>"),f=b.url,g=f.match(k),g&&g.length?f=g[0].replace(k,m):(g=f.match(l),g&&g.length&&(f=g[0].replace(l,m)));var q=b.price;(b.has_buylink===!1||"N/A"===b.price)&&(q="&nbsp"),$('<li class="result-item" data-pos='+(a+1)+'><a target="_blank" href="http://www.diaox2.com/'+f+'" class="imglink f-l"><div class="result-item-img-container loading"><img src="'+h+'" alt="'+c+'" width="188" height="188"></div></a><div class="result-item-detail f-l"><h2 class="detail-title"><a target="_blank" href="'+f+'">'+d+'</a></h2><ul class="detail-keywords clearfix">'+o+'</ul><div class="detail-author clearfix"><a class="detail f-l">'+q+'</a><div class="author f-l clearfix"><ul class="clearfix"><li class="author-face f-l"><a target="_blank" href="'+e+'"><span class="author-face-container"><img src="http://c.diaox2.com/cms/diaodiao/'+b.author.pic+'" width="20" height="20"></span></a></li><li class="author-name f-l"><a target="_blank" href="'+e+'">'+b.author.name+"</a></li></ul></div></div></div></li>").appendTo(p)})}else $(".no-result").find(".target-word").html("“"+(void 0==j?"":j)+"”"),$(".no-result").addClass("disblk");var q=$(".result-item"),f=(q.attr("data-pos"),q.find(".imglink ").attr("href"));q.on("click","a.imglink,.detail-title a",function(a){var b=a.delegateTarget,c=this.href,d=b.getAttribute("data-pos"),e=window.location.href,f=localStorage,g=JSON.parse(f.getItem("statisticsData")),h=g.click_data.search,i=0,k=h.length;if(-1!==e.indexOf("&t=h"))for(;k>i;i++){var l=h[i];if(l.query===j&&"pc_hotQueries"===l.from){var m=l.click,n={url:c,pos:d};m.push(n)}}else for(;k>i;i++){var l=h[i];if(l.query===j){var m=l.click,n={url:c,pos:d};m.push(n)}}f.setItem("statisticsData",JSON.stringify(g))})}var f,g=$.getParam(),h=document.querySelector(".hot-search-word-list"),i=$(h),j=$.getParam().q,k=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,l=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,m="article/$1.html",g=$.getParam(),n=-1!==j.indexOf("礼物"),o=function(a,b){return a.sort(function(){return Math.random()-.5}),a.slice(0,b)};if(g&&g.q&&(document.title=g.q+"_"+document.title,$("#search-input").val(g.q)),n){$(".hot-search").hide(),$(".present-area").css("display","block"),$.ajax({url:"http://s.diaox2.com/view/app/gift_supply.php",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb4",cache:!0,timeout:8e4,error:function(a){console.log("搜索接口的jsonp执行失败！！ "+a)},success:d});var p,q,r,s,t,u={};$(document).on("click",".present-type li",function(){s=$(this),r=s.parent().parent(),r.hasClass("scene")?(p&&p.removeClass("cur-select"),s.addClass("cur-select"),p=s):r.hasClass("relation")?(q&&q.removeClass("cur-select"),s.addClass("cur-select"),q=s):(r.hasClass("character")||r.hasClass("price"))&&s.toggleClass("cur-select"),a()})}else $(".hot-search").show(),$(".present-area").css("display","none"),$.ajax({url:"http://api.diaox2.com/v2/app/config",dataType:"jsonp",type:"GET",jsonp:"cb",jsonpCallback:"cb3",error:function(a){console.log("热搜词接口的jsonp执行失败！！"),console.log(a)},success:function(a){console.log("热搜词接口的jsonp执行成功！！"),f=a.res.search.hot_slide_search_word,f=o(f,5),$.each(f,function(a,b){$('<li class="hot-search-word f-l"><a href="'+window.location.href.split("?")[0]+"?q="+b+'&t=h">'+b+"</a></li>").appendTo(i)})}}),$.ajax({url:"http://s.diaox2.com/ddsearch/q",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb2",cache:!0,timeout:2e4,data:{data:JSON.stringify({query:j,from:"pc"})},error:function(a){console.log("搜索接口的jsonp执行失败！！ "+a)},success:e});$.ajax({url:"http://c.diaox2.com/cms/diaodiao/pcsite/zk_feed_list.json",type:"GET",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb",timeout:2e4,error:function(a){console.log("获取热门专题接口的jsonp执行失败！！"),console.log(a)},success:function(a){console.log("获取热门专题接口的jsonp执行成功！！");var b,c=a.goodthing_feed_list,d=$(".special");$.each(c,function(a,c){if(!(a>1)){b=c.url,match=b.match(k),match&&match.length?b=match[0].replace(k,m):(match=b.match(l),match&&match.length&&(b=match[0].replace(l,m)));var e=c.title,f=0,g=c.title.length,h=titleStr2="";if(2===g)h=e[0],titleStr2=e[1];else{for(;g-1>f;f++)h=h+e[f]+"<br>";titleStr2=e[g-1]}$('<li class="loading"><a target="_blank" href="'+b+'"><img src="'+c.cover_image_url+'" alt="'+h.replace("<br>","")+'" width="277" height="180"><p>'+h+"</p><span>"+titleStr2+'</span><div class="black-musk"></div></a></li>').appendTo(d)}})}});var v,w=window.location.href,x=localStorage,y=x.getItem("statisticsData"),z=y?JSON.parse(y):{};y||(z.method="log_search_click",z.click_data={did:"",search:[]}),v=-1!==w.indexOf("&t=h")?"pc_hotQueries":"pc_searchResult";var A=z.click_data.search,B={query:j,from:v,click:[]};A.push(B),x.setItem("statisticsData",JSON.stringify(z));var C=x.getItem("statisticsData");window.onbeforeunload=function(){C&&$.ajax({url:"http://api.diaox2.com/v2/ubs",type:"POST",async:!1,contentType:"application/json",data:C,success:function(a){localStorage.clear(),localStorage.setItem("word:"+j,JSON.stringify(a))},error:function(a,b){localStorage.setItem("error_info",b),localStorage.setItem("error_info_status",a.status)}})},document.getElementById("search-input").value=document.getElementById("search-input").value.replace(/\+/g," ")});