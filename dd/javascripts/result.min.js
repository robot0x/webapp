/*! diaodiao 李彦峰 2016-06-06 */
$.extend({getParam:function(){var a,b,c,d,e,f=window.location.href,g=f.split("?"),h={},i=0;if(g.length>1&&(c=g[1]),c)for(a=c.split("&"),b=a.length;b>i;i++)d=a[i],e=d.split("="),h[e[0]]=decodeURIComponent(e[1]);return h}}),$(function(){function a(a){var b=document.createElement("b");return b.innerHTML="<!--[if IE "+a+"]><i></i><![end if]-->",1===b.getElementsByTagName("i").length}function b(a){if(null==a)return!0;for(var b in a)return!1;return!0}function c(a){jQuery.support.cors=!0,$.ajax({url:"http://api.diaox2.com/v1/stat/all",data:{data:JSON.stringify({aids:a})},dataType:"jsonp",type:"GET",jsonp:"cb",jsonpCallback:"cb"+Math.ceil(5*Math.random()+15*Math.random()),cache:!0,timeout:2e3,success:d,error:function(a,b,c){console.log("update failed, with error "+c)}})}function d(a){if("SUCCESS"!=a.result)return console.log("update invoked but server fail."),!1;{var b,c,d,e,f=$(".unknown");f.elements}for(b in a.res)for(c=0;c<f.length;c++)d=$(f[c]),b==d.attr("data-id")&&(e=a.res[b],d.find(".a-fav").text(e.fav),d.find(".a-up").text(e.up),d.addClass("known").removeClass("unknown"));return!0}function e(){for(var a,b,d=$(".unknown"),e=[],f=0,g=d.length;g>f;)a=$(d[f++]),b=a.attr("data-id"),isNaN(b)||e.push(+b);return function(a){!function(){var b=a.slice(0,v);return a=a.slice(v),b.length>0?(c(b),void setTimeout(arguments.callee,5e3)):!0}()}(e),!0}function f(a,b){return a.dataset?a.dataset[b]:a.getAttribute("data-"+b)}function g(a){return a?a.replace(/<br\s*\/?\s*>/g,"").replace(/\"/g,"&quot;"):""}function h(a){if(a.count>0){var b,c,d,e,f,h,i,j,k=a.aids,l=a.meta_infos,m="",n=[];$.each(k,function(a,k){b=l[k],f=m="";var o=b.price;o||(b.price="<img width='15' height='15' style='margin-right:5px;' src='http://c.diaox2.com/cms/diaodiao/assets/links.png'>全网结果"),c=b.rendered_keywords,$.each(c,function(a,b){m+=0==a&&b[0]==q?'<li class="f-l"><span class="target-word">'+b[0]+"</span></li>":'<li class="f-l">'+b[0]+"</li>"}),d=b.rendered_title,j=b.thumb_image_url,-1==j.indexOf("http")&&(j="http://a.diaox2.com/cms/sites/default/files/"+j),f=b.author.src||b.author.url,-1==f.indexOf("http")&&(f="editor/"+f+".html"),e=g(d.replace(/<<<<(.*?)>>>>/gi,"$1")),d=g(d.replace(/<<<<(.*?)>>>>/gi,"<span class='target-word'>$1</span>")),h=b.url,i=h.match(s),i&&i.length?h=i[0].replace(s,u):(i=h.match(t),i&&i.length&&(h=i[0].replace(t,u)));var p=b.price;(b.has_buylink===!1||"N/A"===b.price)&&(p="&nbsp"),!o&&/^\/?article\/\d+\.html/.test(h)&&(p="&nbsp"),n.push('<li class="result-item" data-pos=',a+1,'><a target="_blank" href="',r,h,'" class="imglink f-l"><div class="result-item-img-container loading"><img src="',j,'" alt="',e,'" width="188" height="188"></div></a><div class="result-item-detail f-l"><h2 class="detail-title"><a target="_blank" href="',h,'">',d,'</a></h2><ul class="detail-keywords clearfix">',m,'</ul><div class="detail-author clearfix"><a class="detail f-l">',p,'</a><div class="author f-l clearfix"><ul class="clearfix"><li class="author-face f-l"><a target="_blank" href="',f,'"><span class="author-face-container"><img src="http://c.diaox2.com/cms/diaodiao/',b.author.pic,'" width="20" height="20"></span></a></li><li class="author-name f-l"><a target="_blank" href="',f,'">',b.author.name,"</a></li></ul></div></div></div></li>")}),document.getElementById("result-list").innerHTML=n.join("")}else $(".no-result").find(".target-word").html("“"+(void 0==q?"":q)+"”"),$(".no-result").addClass("disblk");var o=$(".result-item"),h=(o.attr("data-pos"),o.find(".imglink ").attr("href"));o.on("click","a.imglink,.detail-title a",function(a){var b,c,d,e=a.delegateTarget,f=this.href,g=e.getAttribute("data-pos"),h=window.location.href,i=localStorage,j=JSON.parse(i.getItem("statisticsData")),k=j.click_data.search,l=0,m=k.length;if(-1!==h.indexOf("&t=h"))for(;m>l;l++)b=k[l],b.query===q&&"pc_hotQueries"===b.from&&(c=b.click,d={url:f,pos:g},c.push(d));else for(;m>l;l++)b=k[l],b.query===q&&(c=b.click,d={url:f,pos:g},c.push(d));i.setItem("statisticsData",JSON.stringify(j))})}function j(a){var b=document.querySelector(".rectangle-bounce");b&&(b.style.display=a)}function k(a,b,c){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},c)}function l(a,b,c){var d=a["on"+b];a["on"+b]=d?function(){d(),c()}:c}var m,n=$.getParam(),o=document.querySelector(".hot-search-word-list"),p=$(o),q=$.getParam().q,r="",s=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,t=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,u="article/$1.html",n=$.getParam(),v=20,w=(-1!==q.indexOf("礼物"),function(a,b){return a.sort(function(){return Math.random()-.5}),a.slice(0,b)});n&&n.q&&(document.title=n.q+"_"+document.title,$("#search-input").val(n.q)),$.ajax({url:"http://s.diaox2.com/ddsearch/q",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb2",data:{data:JSON.stringify({query:q,from:"pc"})},cache:!0,timeout:2e4,success:function(c){function d(a){K=a;var b=a.gift_tag_index;return $.extend(L,b.scene,b.relation,b.character),"礼物"!==q?void g(C):void x(a.meta_infos)}function g(a){a.forEach(function(a){A.call(document.querySelector('[data-title="'+a+'"]'))})}function n(){var a,b,c=$(".scene .cur-select,.relation .cur-select,.character .cur-select"),d=$(".price .cur-select"),e=[],g=[],h=[],i=[],j=[],k=[];return c.each(function(a,b){"character"===f(b,"group")?g.push(f(b,"title")):h.push(f(b,"title"))}),g.length&&(i=[],g.forEach(function(a){i.push(L[a])}),j.push(1===i.length?i[0]:i.reduce(function(a,b){return a.concat(b)}).unique())),d.length&&d.each(function(a,b){e.push(b.getAttribute("data-title"))}),e.length&&(a=z(e),j.push(a)),h.forEach(function(a){j.push(L[a])}),j.length&&(b=j.reduce(function(a,b){return a.forEach(function(a){b.forEach(function(b){a===b&&k.push(a)})}),k})),(b||[]).sort(function(a,b){return b-a})}function o(){var a=n(),b=K.meta_infos,c={};if(a&&a.length)a.forEach(function(a){b[a]&&(c[a]=b[a])}),$(".no-result").hide(),$(".no-result p.f-l").html('找不到<span class="target-word"></span>，换个关键词试试'),x(c);else{var d=document.querySelectorAll(".cur-select");d.length?(document.getElementById("goodthing-list").innerHTML="",$(".no-result").show(),$(".no-result p.f-l").text("没有结果，换个组合试试"),j("none")):x(b)}}function x(a){var b,c,d,f,g,h=document.getElementById("goodthing-list"),j=[];for(gift_tag_index=B.gift_tag_index,ks=G(a).sort(function(a,b){return b-a}),count=i=0,length=ks.length,dataPos=1,h.innerHTML="";i<length&&(b=+ks[i++],count++!==v);)F||(F=a),everyMeta=a[b],everyMeta&&(c=everyMeta.cover_image_url,d=everyMeta.rendered_title,g=everyMeta.price,everyMeta.has_buylink&&null!=g&&"N/A"!==g||(g="&nbsp"),f=everyMeta.url,f&&(match=f.match(s),match&&match.length?f=match[0].replace(s,u):(match=f.match(t),match&&match.length&&(f=match[0].replace(t,u)))),c&&-1==c.indexOf("http")&&(c="http://a.diaox2.com/cms/sites/default/files/"+c),j.push('<li class="goodthing" data-pos='+dataPos++ +'><a href="',r,f,'" target="_blank"><div class="img-container"><img src="',c,'" alt="',d,'" onload="adjust(this)"></div><div class="goodthing-highlight"><h2><div>',d,'</div></h2><ul class="icon-list clearfix unknown" data-id=',Math.pow(2,32)*b+b,'><li class="icon-item f-l"><span>',g,'</span></li><li class="icon-item f-r"><i class="icon icon-s"></i><span class="a-fav">...</span></li><li class="icon-item f-r"><i class="icon icon-z"></i><span class="a-up">...</span></li></ul></div></a></li>'),delete a[b]);F=a,document.getElementById("goodthing-list").innerHTML=j.join(""),e(),$(h).on("click","li a",function(){var a,b,c,d=this.parentNode,e=this.href,f=d.getAttribute("data-pos"),g=window.location.href,h=localStorage,i=JSON.parse(h.getItem("statisticsData")),j=i.click_data.search,k=0,l=j.length;if(-1!==g.indexOf("&t=h"))for(;l>k;k++)a=j[k],a.query===q&&"pc_hotQueries"===a.from&&(b=a.click,c={url:e,pos:f},b.push(c));else for(;l>k;k++)a=j[k],a.query===q&&(b=a.click,c={url:e,pos:f},b.push(c));h.setItem("statisticsData",JSON.stringify(i))})}function y(){if(console.log(F),b(F))return void j("none");console.log(B);for(var a,c,d,f,g,h,k,l,m,n,o,p=document.getElementById("goodthing-list"),q=p.querySelector(".goodthing"),w=document.createDocumentFragment(),x=(B.gift_tag_index,G(F).sort(function(a,b){return b-a})),y=i=0,z=x.length,A=1;i<z;){var a=+x[i++];if(!a||isNaN(a)||y++===v)break;h=q.cloneNode(!0),k=h.querySelector("a"),l=k.querySelector(".img-container img"),m=k.querySelector(".goodthing-highlight h2 div"),o=k.querySelector(".icon-list"),n=o.querySelector(".f-l span"),everyMeta=F[a],everyMeta&&(c=everyMeta.cover_image_url,d=everyMeta.rendered_title,g=everyMeta.price,everyMeta.has_buylink&&null!=g&&"N/A"!==g||(g="&nbsp"),f=everyMeta.url,f&&(match=f.match(s),match&&match.length?f=match[0].replace(s,u):(match=f.match(t),match&&match.length&&(f=match[0].replace(t,u)))),c&&-1==c.indexOf("http")&&(c="http://a.diaox2.com/cms/sites/default/files/"+c),l.removeAttribute("width"),l.removeAttribute("height"),l.removeAttribute("style"),h.setAttribute("data-pos",A++),k.href=r+f,l.src=c,l.alt=d,o.className="icon-list clearfix unknown",o.setAttribute("data-id",Math.pow(2,32)*a+ +a),m.innerHTML=d,n.innerHTML=g,w.appendChild(h)),delete F[a]}p.appendChild(w),e()}function z(a){var b,c,d,e,f,g=/\d+((\.|,)\d+)?/g,h=[],i=K.meta_infos;return a.forEach(function(a){b=a.split("-");for(d in i)d=+d,e=i[d],c=e.has_buylink,f=e.price,c&&f&&(f=f.match(g),f&&f.length&&(f=f[0],-1!==f.indexOf(",")&&(f=f.split(",").join("")),f=parseFloat(f)),f>=b[0]&&(b[1]?f<b[1]&&-1===h.indexOf(d)&&h.push(d):-1===h.indexOf(d)&&h.push(d)))}),h}function A(){J=$(this);var a=this.getAttribute("data-group");if("scene"===a){if(H&&(H.removeClass("cur-select"),H.attr("data-title")===J.attr("data-title")))return H=void 0,void o();J.addClass("cur-select"),H=J}else if("relation"===a){if(I&&(I.removeClass("cur-select"),I.attr("data-title")===J.attr("data-title")))return I=void 0,void o();J.addClass("cur-select"),I=J}else("character"===a||"price"===a)&&J.toggleClass("cur-select");o()}if(c.special_query&&"gift"===c.special_query.query_type){var C=c.special_query.gift_tag_query_info.tags;if(Array.prototype.unique=function(){for(var a={},b=[],c=0,d=this.length;d>c;c++)a[this[c]]||(a[this[c]]=!0,b.push(this[c]));return b},"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(a){for(var b=0,c=this.length;c>b;)a(this[b],b++)}),"function"!=typeof Array.prototype.reduce&&(Array.prototype.reduce=function(a,b){var c=b,d=0,e=this.length;if("undefined"==typeof b&&(c=this[0],d=1),"function"==typeof a)for(d;e>d;d++)this.hasOwnProperty(d)&&(c=a(c,this[d],d,this));return c}),"function"!=typeof Array.prototype.indexOf&&(Array.prototype.indexOf=function(a){for(var b=0,c=this.length;c>b&&a!==this[b];b++);return b===c?-1:b}),$(".present").addClass("current-page"),a(9)){var D=document.querySelector(".present-result"),E=document.createElement("div");D.removeChild(D.querySelector(".rectangle-bounce")),E.innerHTML="正在加载...",E.className="IE9LOADING",D.appendChild(E)}$(".hot-search").hide(),$(".present-area").css("display","block");var F,G=Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b};l(window,"scroll",function(){if(document.querySelector(".goodthing")){var b=document.body.clientHeight,c=document.documentElement.offsetHeight,d=document.documentElement.scrollTop||document.body.scrollTop,e=d+c;a(9)||a(8)?Math.abs(e-b)<=150&&k(y,window,700):e===b&&(k(y,window,700),j("block"))}}),$.ajax({url:"http://s.diaox2.com/view/app/gift_supply.php",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb4",cache:!0,timeout:1e5,success:d});var H,I,D,J,K,L={};$(document).on("click",".present-type li",function(){k(A,this,300)})}else $(".hot-search").show(),$(".present-area").css("display","none"),h(c),$.ajax({url:"http://api.diaox2.com/v2/app/config",dataType:"jsonp",type:"GET",jsonp:"cb",jsonpCallback:"cb3",cache:!0,success:function(a){m=a.res.search.hot_slide_search_word,m=w(m,5),$.each(m,function(a,b){$('<li class="hot-search-word f-l"><a href="'+window.location.href.split("?")[0]+"?q="+b+'&t=h">'+b+"</a></li>").appendTo(p)})}})}}),$.ajax({url:"http://c.diaox2.com/cms/diaodiao/pcsite/zk_feed_list.json",type:"GET",dataType:"jsonp",jsonp:"cb",jsonpCallback:"cb",cache:!0,timeout:2e4,success:function(a){var b,c,d=a.goodthing_feed_list,c=[];$.each(d,function(a,d){if(!(a>1)){b=d.url,match=b.match(s),match&&match.length?b=match[0].replace(s,u):(match=b.match(t),match&&match.length&&(b=match[0].replace(t,u)));var e=d.title,f=0,h=d.title.length,i=titleStr2="";if(2===h)i=e[0],titleStr2=e[1];else{for(;h-1>f;f++)i=i+e[f]+"<br>";titleStr2=e[h-1]}c.push('<li class="loading"><a target="_blank" href="',b,'"><img src="',d.cover_image_url,'" alt="',g(i),'" width="277" height="180"><p>',i,"</p><span>",titleStr2,'</span><div class="black-musk"></div></a></li>')}}),document.getElementById("special").innerHTML=c.join("")}});var x,y=window.location.href,z=localStorage,A=z.getItem("statisticsData"),B=A?JSON.parse(A):{};A||(B.method="log_search_click",B.click_data={did:"",search:[]}),x=-1!==y.indexOf("&t=h")?"pc_hotQueries":"pc_searchResult";var C=B.click_data.search,D={query:q,from:x,click:[]};C.push(D),z.setItem("statisticsData",JSON.stringify(B));var E=z.getItem("statisticsData");window.onbeforeunload=function(){E&&$.ajax({url:"http://api.diaox2.com/v2/ubs",type:"POST",async:!1,contentType:"application/json",data:E,success:function(a){localStorage.clear(),localStorage.setItem("word:"+q,JSON.stringify(a))},error:function(a,b){localStorage.setItem("error_info",b),localStorage.setItem("error_info_status",a.status)}})},document.getElementById("search-input").value=document.getElementById("search-input").value.replace(/\+/g," ")});