/*! diaodiao 李彦峰 2017-03-09 */
$(function(){function a(a){var b="";if(!a||!a.coupon)return b;var c=a.coupon.code,d=a.coupon.link,e="",f="",g=0,h=0,i=!1,j=!1;if(d&&d.length>0){for(e='<tr class="get-coupon">',h=d.length;h>g;g++){var k=d[g],l=k.url;/.*diaox2\.com.*/i.test(l)||(e+='<td>领取优惠券</td><td><a target="_blank" href="'+(d[g].urlpc||d[g].url)+'">'+d[g].text+"</a></td>",i||(i=!0))}e+="</tr>"}if(c&&c.length>0)for(j=!0,f="",g=0,h=c.length;h>g;g++)f+='<tr class="copy-code"><td>优惠码</td><td><input class="code" type="text" value="'+c[g].code+'" readonly></td></tr>';return(i||j)&&(b='<table class="code-table" cellpadding="0" cellspacing="0"><tbody>',i&&(b+=e),j&&(b+=f),b+="</tbody></table>"),b}function b(a,b){return a.sort(function(){return Math.random()-.5}).slice(0,b)}function c(a){return new Date(a).getFullYear()===(new Date).getFullYear()}function d(a){var b=new Date,d=new Date(a);return c(a)&&b.getMonth()===d.getMonth()&&b.getDate()===d.getDate()?!0:!1}function e(a,b,c){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},c)}function f(a,b,c){var d=a["on"+b];a["on"+b]=d?function(){d(),c()}:c}function g(a){var b=document.querySelector(".rectangle-bounce");b&&(b.style.display=a)}function h(a){var b=document.createElement("b");return b.innerHTML="<!--[if IE "+a+"]><i></i><![end if]-->",1===b.getElementsByTagName("i").length}function i(a){return a?a.startsWith("<")||a.endsWith(">")?a.replace(/</g,"\n<").replace(/>/g,">\n").replace(/\n\n/g,"\n").replace(/^\n/g,"").replace(/\n$/g,"").split("\n").filter(function(a){return!a.startsWith("<")}).join("").replace(/&nbsp;?|<br\s*\/*>|\s*/gi,""):a:""}function j(a){var b=new Date(a),e="";return c(a)?d(a)?(minutes=b.getMinutes(),minutes<10&&(minutes="0"+minutes),e+=b.getHours()+":"+minutes):e+=b.getMonth()+1+"-"+b.getDate():e+=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate(),e}function k(a){if(a){var b=document.createDocumentFragment();return b.appendChild(a),b.removeChild(a),a}}function l(a,b,c){if(b=b||function(){},c=c||function(){},window.clipboardData){var d=window.clipboardData.setData("Text",a);d?b():c()}else{var e=document.createElement("textarea"),f=["position:","fixed;","top:","0;","left:","0;","padding:","0;","width:","31px;","height:","21px;","border:","none;","outline:","none;","boxShadow:","none;","background:","transparent;","opacity:","0;","z-index:","-1;"];e.style.cssText=f.join(""),e.value=a,document.body.appendChild(e),e.select();try{var d=document.execCommand("copy"),g=d?"successful":"unsuccessful";console.log("Copying text command was "+g);try{d?b():c()}catch(h){console.log("执行success或error有异常！！！！！"),console.error(h)}}catch(h){console.log("Oops, unable to copy"),c()}document.body.removeChild(e)}}function m(){if(0===q.length)return void g("none");for(var b,c,d,e,f,h,l,m=document.getElementById("result-list"),n=m.querySelector(".result-list > li"),r=document.createDocumentFragment(),s=count=0;s<q.length&&(d=q[s],!(count>u-1));s++,count++){b=o[p.indexOf(d[0])],c=b.url,e=n.cloneNode(!0),1===d[1]?$(e).addClass("outdate"):$(e).removeClass("outdate");var t=e.querySelector("code-table");for(t&&k(t),f=e.querySelectorAll("a"),h=f.length,l=0;h>l;l++)f[l].href=c;e.querySelector(".result-title").innerHTML=b.title[0],e.querySelector("img").src=removeProtocol(b.thumb_image_url),e.querySelector(".result-price").innerHTML=null==b.price?"&nbsp;":b.price,e.querySelector(".result-content").innerHTML=y?b.title[0]:i(b.summary);var v=e.querySelector(".result-footer");v.querySelector(".date").innerHTML=j(1e3*b.pub_time);var w="";b.author&&(w=b.author.name),v.querySelector(".source").innerHTML=w,v.querySelector(".buylink_site").innerHTML=b.buylink_site||"";var x=a(b);x&&v.insertAdjacentHTML("beforebegin",x),r.appendChild(e),q.splice(s--,1)}m.appendChild(r)}function n(a,b,c){function d(){k(e),window.removeEventListener("scroll",d),console.log("scroll")}if(a&&b){var e=document.querySelector(".stick-tip"),f=b.getBoundingClientRect(),g=f.top,h=f.left,i=f.width||b.offsetWidth,e=document.querySelector(".stick-tip");e&&k(e),document.body.insertAdjacentHTML("beforeend",'<div class="stick-tip">'+a+"</div>"),e=document.querySelector(".stick-tip");var j=e.offsetWidth,l=e.offsetHeight,m=g-l,n=h+(i-j)/2;e.style.cssText="left:"+n+"px;top:"+m+"px",setTimeout(function(){k(e)},c||1800),window.addEventListener("scroll",d)}}var o,p,q,r=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,s=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,t="$1.html",u=30,v=Array.prototype,w=String.prototype,x=v.forEach,y=h(8),z=h(9);if(y||z){var A=document.querySelector(".main-content"),B=document.createElement("div");A.removeChild(A.querySelector(".rectangle-bounce")),B.innerHTML="正在加载...",B.className="IE9LOADING",A.appendChild(B)}$.ajax({url:"//c.diaox2.com/view/app/?m=recommend",type:"GET",cache:!0,dataType:"jsonp",crossDomain:!0,jsonpCallback:"mycb",jsonp:"cb",success:function(a){var c,d,e,f=[];$(".success-remove").remove(),a=b(a,4),$.each(a,function(a,b){c=b.url,e=b.thumb,-1==e.indexOf("http")&&(e="//a.diaox2.com/cms/sites/default/files/"+e),e=removeProtocol(e),d=c.match(r),d&&d.length?c=d[0].replace(r,t):(d=c.match(s),d&&d.length&&(c=d[0].replace(s,t))),f.push('<li class="f-l"><a href="article/',c,'"><img src="',removeProtocol(b.thumb),'" alt="',b.title,'" width="144" height="144"><p>',b.title,"</p></a></li>")}),document.getElementById("hot-list").innerHTML=f.join(""),$(".result-content").trigger("update")},error:function(a){console.log("recmmend error!"),console.log(a)}}),$.ajax({url:"//api.diaox2.com/v4/zdm",type:"GET",cache:!0,dataType:"jsonp",crossDomain:!0,data:{data:JSON.stringify({device_info:{client:"pc"},method:"get_all",client_data_version:0})},jsonpCallback:"cb",jsonp:"cb",success:function(b){var c,d,e,f,g,h,k,l,m,n,r,s,t=[],v=[],w=0,z=0;if(b||"SUCCESS"===b.state){for(c=b.res,d=c.meta_infos,console.log("共"+d.length+"条数据"),o=d,x.call(d,function(a){t.push(a.cid)}),p=t,e=c.feed_list;w<e.length&&(s=e[w],!(z>u-1));w++,z++){f=d[t.indexOf(s[0])],h=f.url,k=i(f.summary),l=f.price,(null==l||"null"==l)&&(l="&nbsp;"),m=1e3*f.pub_time,n="",f.author&&(n=f.author.name),r=f.thumb_image_url,g=f.title[0],buylink_site=f.buylink_site||"";var A=a(f);v.push('<li class="result-item clearfix',1===s[1]?"outdate":"",'"><div class="img-container f-l loading"><a target="_blank" href="',h,'"><img src="',removeProtocol(r),'" alt="',g,'" height="188" width="188"></a><span class="outdate-tag disnone">已过期</span></div><div class="result-detail f-l"><p class="result-title">',g,'</p><p class="result-price">',l,'</p><p class="result-content">',y?g:k,"</p>",A,'<ul class="result-footer clearfix"><li class="date f-l">',j(m),'</li><li class="source f-l">',n,'</li><li class="view-result f-r"><a target="_blank" href="',h,'"><p>查看详情</p></a></li><li class="buylink_site f-r">',buylink_site,"</li></ul></div></div>"),e.splice(w--,1)}q=e,document.getElementById("result-list").innerHTML=v.join("")}else console.log("zdm failed!"),console.log(b)},error:function(a){console.log("zdm error!"),console.log(a)}}),"function"!=typeof x&&(x=function(a){for(var b=0,c=this.length;c>b;)a(this[b],b++)}),"function"!=typeof v.indexOf&&(v.indexOf=function(a){for(var b=0,c=this.length;c>b&&a!==this[b];b++);return b===c?-1:b}),"function"!=typeof v.filter&&(v.filter=function(a){for(var b,c=[],d=0,e=this.length;e>d;)b=this[d++],a(b)&&c.push(b);return c}),"function"!=typeof w.startsWith&&(w.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof w.endsWith&&(w.endsWith=function(){return this.indexOf===this.length-1}),f(window,"scroll",function(){var a=document.body.clientHeight,b=document.documentElement.offsetHeight,c=document.documentElement.scrollTop||document.body.scrollTop,d=c+b;z||y?Math.abs(d-a)<=150&&e(m,window,700):Math.abs(d-a)<=2&&(e(m,window,700),g("block"))}),$(document.body).on("click",".code-table .code",function(){var a=this;l(this.value,function(){n("拷贝成功",a)},function(){var b="Ctrl-C";/(Mac\s*)?OS\s*X/i.test(navigator.userAgent)&&(b="⌘-C"),a.select(),n("请使用"+b+"复制",a)})})});