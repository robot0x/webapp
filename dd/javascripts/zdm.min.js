/*! diaodiao 李彦峰 2016-10-09 */
$(function(){function a(a){var b="";if(!a||!a.coupon)return b;var c=a.coupon.code,d=a.coupon.link,e="",f="",g=0,h=0,i=!1,j=!1;if(d&&d.length>0){for(e='<tr class="get-coupon">',h=d.length;h>g;g++){var k=d[g],l=k.url;/.*diaox2\.com.*/i.test(l)||(e+='<td>领取优惠券</td><td><a target="_blank" href="'+(d[g].urlpc||d[g].url)+'">'+d[g].text+"</a></td>",i||(i=!0))}e+="</tr>"}if(c&&c.length>0){for(j=!0,f='<tr class="copy-code">',g=0,h=c.length;h>g;g++)f+='<td>优惠码</td><td><input class="code" type="text" value="'+c[g].code+'" readonly></td>';f+="</tr>"}return(i||j)&&(b='<table class="code-table" cellpadding="0" cellspacing="0"><tbody>',i&&(b+=e),j&&(b+=f),b+="</tbody></table>"),b}function b(a,b){return a.sort(function(){return Math.random()-.5}).slice(0,b)}function c(a){return new Date(a).getFullYear()===(new Date).getFullYear()}function d(a){var b=new Date,d=new Date(a);return c(a)&&b.getMonth()===d.getMonth()&&b.getDate()===d.getDate()?!0:!1}function e(a,b,c){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},c)}function f(a,b,c){var d=a["on"+b];a["on"+b]=d?function(){d(),c()}:c}function g(a){var b=document.querySelector(".rectangle-bounce");b&&(b.style.display=a)}function h(a){var b=document.createElement("b");return b.innerHTML="<!--[if IE "+a+"]><i></i><![end if]-->",1===b.getElementsByTagName("i").length}function i(a){return a?a.startsWith("<")||a.endsWith(">")?a.replace(/</g,"\n<").replace(/>/g,">\n").replace(/\n\n/g,"\n").replace(/^\n/g,"").replace(/\n$/g,"").split("\n").filter(function(a){return!a.startsWith("<")}).join("").replace(/&nbsp;?|<br\s*\/*>|\s*/gi,""):a:""}function j(a){var b=new Date(a),e="";return c(a)?d(a)?(minutes=b.getMinutes(),minutes<10&&(minutes="0"+minutes),e+=b.getHours()+":"+minutes):e+=b.getMonth()+1+"-"+b.getDate():e+=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate(),e}function k(a){var b={ellipsis:"......",wrap:"letter"};"string"==typeof a?$(a).dotdotdot(b):a.dotdotdot(b)}function l(a){if(a){var b=document.createDocumentFragment();return b.appendChild(a),b.removeChild(a),a}}function m(a,b,c){if(b=b||function(){},c=c||function(){},window.clipboardData){var d=window.clipboardData.setData("Text",a);d?b():c()}else{var e=document.createElement("textarea"),f=["position:","fixed;","top:","0;","left:","0;","padding:","0;","width:","31px;","height:","21px;","border:","none;","outline:","none;","boxShadow:","none;","background:","transparent;","opacity:","0;","z-index:","-1;"];e.style.cssText=f.join(""),e.value=a,document.body.appendChild(e),e.select();try{var d=document.execCommand("copy"),g=d?"successful":"unsuccessful";console.log("Copying text command was "+g);try{d?b():c()}catch(h){console.log("执行success或error有异常！！！！！"),console.error(h)}}catch(h){console.log("Oops, unable to copy"),c()}document.body.removeChild(e)}}function n(){if(0===r.length)return void g("none");for(var b,c,d,e,f,h,m,n=document.getElementById("result-list"),o=n.querySelector(".result-list > li"),s=document.createDocumentFragment(),t=count=0;t<r.length&&(d=r[t],!(count>v-1));t++,count++){b=p[q.indexOf(d[0])],c=b.url,e=o.cloneNode(!0),1===d[1]?$(e).addClass("outdate"):$(e).removeClass("outdate");var u=e.querySelector("code-table");for(u&&l(u),f=e.querySelectorAll("a"),h=f.length,m=0;h>m;m++)f[m].href=c;e.querySelector(".result-title").innerHTML=b.title[0],e.querySelector("img").src=b.thumb_image_url,e.querySelector(".result-price").innerHTML=null==b.price?"&nbsp;":b.price,e.querySelector(".result-content").innerHTML=z?b.title[0]:i(b.summary);var w=e.querySelector(".result-footer");w.querySelector(".date").innerHTML=j(1e3*b.pub_time),w.querySelector(".source").innerHTML=b.author.name,w.querySelector(".buylink_site").innerHTML=b.buylink_site||"";var x=a(b);x&&w.insertAdjacentHTML("beforebegin",x),s.appendChild(e),r.splice(t--,1)}n.appendChild(s),k(".result-content")}function o(a,b,c){function d(){l(e),window.removeEventListener("scroll",d),console.log("scroll")}if(a&&b){var e=document.querySelector(".stick-tip"),f=b.getBoundingClientRect(),g=f.top,h=f.left,i=f.width||b.offsetWidth,e=document.querySelector(".stick-tip");e&&l(e),document.body.insertAdjacentHTML("beforeend",'<div class="stick-tip">'+a+"</div>"),e=document.querySelector(".stick-tip");var j=e.offsetWidth,k=e.offsetHeight,m=g-k,n=h+(i-j)/2;e.style.cssText="left:"+n+"px;top:"+m+"px",setTimeout(function(){l(e)},c||1800),window.addEventListener("scroll",d)}}var p,q,r,s=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,t=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,u="$1.html",v=30,w=Array.prototype,x=String.prototype,y=w.forEach,z=h(8),A=h(9);if(z||A){var B=document.querySelector(".main-content"),C=document.createElement("div");B.removeChild(B.querySelector(".rectangle-bounce")),C.innerHTML="正在加载...",C.className="IE9LOADING",B.appendChild(C)}$.ajax({url:"http://c.diaox2.com/view/app/?m=recommend",type:"GET",cache:!0,dataType:"jsonp",crossDomain:!0,jsonpCallback:"mycb",jsonp:"cb",success:function(a){var c,d,e,f=[];$(".success-remove").remove(),a=b(a,4),$.each(a,function(a,b){c=b.url,e=b.thumb,-1==e.indexOf("http")&&(e="http://a.diaox2.com/cms/sites/default/files/"+e),d=c.match(s),d&&d.length?c=d[0].replace(s,u):(d=c.match(t),d&&d.length&&(c=d[0].replace(t,u))),f.push('<li class="f-l"><a href="article/',c,'"><img src="',b.thumb,'" alt="',b.title,'" width="144" height="144"><p>',b.title,"</p></a></li>")}),document.getElementById("hot-list").innerHTML=f.join(""),$(".result-content").trigger("update")},error:function(a){console.log("recmmend error!"),console.log(a)}}),$.ajax({url:"http://api.diaox2.com/v3/zdm",type:"GET",cache:!0,dataType:"jsonp",crossDomain:!0,data:{data:JSON.stringify({method:"get_all_pc"})},jsonpCallback:"cb",jsonp:"cb",success:function(b){var c,d,e,f,g,h,l,m,n,o,s,t,u=[],w=[],x=0,A=0;if(b||"SUCCESS"===b.state){for(c=b.res,d=c.meta_infos,p=d,y.call(d,function(a){u.push(a.cid)}),q=u,e=c.feed_list;x<e.length&&(t=e[x],!(A>v-1));x++,A++){f=d[u.indexOf(t[0])],h=f.url,l=i(f.summary),m=f.price,(null==m||"null"==m)&&(m="&nbsp;"),n=1e3*f.pub_time,o=f.author.name,s=f.thumb_image_url,g=f.title[0],buylink_site=f.buylink_site||"";var B=a(f);w.push('<li class="result-item clearfix',1===t[1]?"outdate":"",'"><div class="img-container f-l loading"><a target="_blank" href="',h,'"><img src="',s,'" alt="',g,'" height="188" width="188"></a><span class="outdate-tag disnone">已过期</span></div><div class="result-detail f-l"><p class="result-title">',g,'</p><p class="result-price">',m,'</p><p class="result-content">',z?g:l,"</p>",B,'<ul class="result-footer clearfix"><li class="date f-l">',j(n),'</li><li class="source f-l">',o,'</li><li class="view-result f-r"><a target="_blank" href="',h,'"><p>查看详情</p></a></li><li class="buylink_site f-r">',buylink_site,"</li></ul></div></div>"),e.splice(x--,1)}r=e,document.getElementById("result-list").innerHTML=w.join(""),k(".result-content")}else console.log("zdm failed!"),console.log(b)},error:function(a){console.log("zdm error!"),console.log(a)}}),"function"!=typeof y&&(y=function(a){for(var b=0,c=this.length;c>b;)a(this[b],b++)}),"function"!=typeof w.indexOf&&(w.indexOf=function(a){for(var b=0,c=this.length;c>b&&a!==this[b];b++);return b===c?-1:b}),"function"!=typeof w.filter&&(w.filter=function(a){for(var b,c=[],d=0,e=this.length;e>d;)b=this[d++],a(b)&&c.push(b);return c}),"function"!=typeof x.startsWith&&(x.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof x.endsWith&&(x.endsWith=function(){return this.indexOf===this.length-1}),f(window,"scroll",function(){var a=document.body.clientHeight,b=document.documentElement.offsetHeight,c=document.documentElement.scrollTop||document.body.scrollTop,d=c+b;A||z?Math.abs(d-a)<=150&&e(n,window,700):d===a&&(e(n,window,700),g("block"))}),$(document.body).on("click",".code-table .code",function(){var a=this;m(this.value,function(){o("拷贝成功",a)},function(){var b="Ctrl-C";/(Mac\s*)?OS\s*X/i.test(navigator.userAgent)&&(b="⌘-C"),a.select(),o("请使用"+b+"复制",a)})})});