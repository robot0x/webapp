/*! diaodiao 李彦峰 2017-03-09 */
$(function(){function a(a,b){return a.sort(function(){return Math.random()-.5}),a.slice(0,b)}function b(a){return new Date(a).getFullYear()===(new Date).getFullYear()}function c(a){var c=new Date,d=new Date(a);return b()&&c.getMonth()===d.getMonth()&&c.getDate()===d.getDate()?!0:!1}function d(a,b,c){clearTimeout(a.tId),a.tId=setTimeout(function(){a.call(b)},c)}function e(a,b,c){var d=a["on"+b];a["on"+b]=d?function(){d(),c()}:c}function f(a){var b=document.querySelector(".rectangle-bounce");b&&(b.style.display=a)}function g(a){var b=document.createElement("b");return b.innerHTML="<!--[if IE "+a+"]><i></i><![end if]-->",1===b.getElementsByTagName("i").length}function h(a){return a?a.startsWith("<")||a.endsWith(">")?a.replace(/</g,"\n<").replace(/>/g,">\n").replace(/\n\n/g,"\n").replace(/^\n/g,"").replace(/\n$/g,"").split("\n").filter(function(a){return!a.startsWith("<")}).join("").replace(/&nbsp;?|<br\s*\/*>|\s*/gi,""):a:""}function i(a){var d=new Date(a),e="";return b(a)?c(a)?(minutes=d.getMinutes(),minutes<10&&(minutes="0"+minutes),e+=d.getHours()+":"+minutes):e+=d.getMonth()+1+"-"+d.getDate():e+=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate(),e}function j(a){var b={ellipsis:"......",wrap:"letter"};"string"==typeof a?$(a).dotdotdot(b):a.dotdotdot(b)}function k(){if(0===n.length)return void f("none");for(var a,b,c,d=document.getElementById("result-list"),e=d.querySelector(".result-item"),g=document.createDocumentFragment(),k=count=0;k<n.length&&(item=n[k],!(count>r-1));k++,count++)a=l[m.indexOf(item[0])],b=a.url,c=e.cloneNode(!0),1===item[1]?$(c).addClass("outdate"):$(c).removeClass("outdate"),u.call(c.querySelectorAll("a"),function(c){c.href=b,-1!==c.className.indexOf("result-title")&&(c.innerHTML=a.title[0])}),c.querySelector("img").src=a.thumb_image_url,c.querySelector(".result-price").innerHTML=null==a.price?"&nbsp;":a.price,c.querySelector(".result-content").innerHTML=v?a.title[0]:h(a.summary),c.querySelector(".result-footer .date").innerHTML=i(1e3*a.pub_time),c.querySelector(".result-footer .source").innerHTML=a.author.name,g.appendChild(c),n.splice(k--,1);d.appendChild(g),j(".result-content")}var l,m,n,o=/\/view\/app\/\?m=(?:show|zk|scene)&id=(\d+)?(&ch=goodthing)?/i,p=/\/cms\/diaodiao\/articles\/(?:goodthing|firstpage|experience|weekend)\/\d+_(\d+)?\.html/i,q="$1.html",r=30,s=Array.prototype,t=String.prototype,u=s.forEach,v=g(8),w=g(9);if(v||w){var x=document.querySelector(".main-content"),y=document.createElement("div");x.removeChild(x.querySelector(".rectangle-bounce")),y.innerHTML="正在加载...",y.className="IE9LOADING",x.appendChild(y)}$.ajax({url:"http://c.diaox2.com/view/app/?m=recommend",type:"GET",cache:!0,dataType:"jsonp",crossDomain:!0,jsonpCallback:"mycb",jsonp:"cb",success:function(b){var c,d,e,f=[];$(".success-remove").remove(),b=a(b,4),$.each(b,function(a,b){c=b.url,e=b.thumb,-1==e.indexOf("http")&&(e="http://a.diaox2.com/cms/sites/default/files/"+e),d=c.match(o),d&&d.length?c=d[0].replace(o,q):(d=c.match(p),d&&d.length&&(c=d[0].replace(p,q))),f.push('<li class="f-l"><a href="article/',c,'"><img src="',b.thumb,'" alt="',b.title,'" width="144" height="144"><p>',b.title,"</p></a></li>")}),document.getElementById("hot-list").innerHTML=f.join(""),$(".result-content").trigger("update")},error:function(a){console.log("recmmend error!"),console.log(a)}}),$.ajax({url:"http://api.diaox2.com/v3/zdm",type:"GET",cache:!0,dataType:"jsonp",crossDomain:!0,data:{data:JSON.stringify({method:"get_all_pc"})},jsonpCallback:"cb",jsonp:"cb",success:function(a){var b,c,d,e,f,g,k,o,p,q,s,t,w=[],x=[],y=count=0;if(a||"SUCCESS"===a.state){for(b=a.res,c=b.meta_infos,l=c,u.call(c,function(a){w.push(a.cid)}),m=w,d=b.feed_list;y<d.length&&(t=d[y],!(count>r-1));y++,count++)e=c[w.indexOf(t[0])],g=e.url,k=h(e.summary),o=e.price,(null==o||"null"==o)&&(o="&nbsp;"),p=1e3*e.pub_time,q=e.author.name,s=e.thumb_image_url,f=e.title[0],x.push('<li class="result-item clearfix ',1===t[1]?"outdate":"",'"><a target="_blank" href="',g,'" class="img-container f-l loading"><img src="',s,'" alt="',f,'" height="188" width="188"><span class="outdate-tag disnone">已过期</span></a><div class="result-detail f-l"><a target="_blank" href="',g,'" class="result-title">',f,'</a><p class="result-price">',o,'</p><p class="result-content">',v?f:k,'</p><ul class="result-footer clearfix"><li class="date f-l">',i(p),'</li><li class="source f-l">',q,'</li><li class="view-result f-r"><a target="_blank" href="',g,'">查看详情</a></li></ul></div></li>'),d.splice(y--,1);n=d,document.getElementById("result-list").innerHTML=x.join(""),j(".result-content")}else console.log("zdm failed!"),console.log(a)},error:function(a){console.log("zdm error!"),console.log(a)}}),"function"!=typeof u&&(u=function(a){for(var b=0,c=this.length;c>b;)a(this[b],b++)}),"function"!=typeof s.indexOf&&(s.indexOf=function(a){for(var b=0,c=this.length;c>b&&a!==this[b];b++);return b===c?-1:b}),"function"!=typeof s.filter&&(s.filter=function(a){for(var b,c=[],d=0,e=this.length;e>d;)b=this[d++],a(b)&&c.push(b);return c}),"function"!=typeof t.startsWith&&(t.startsWith=function(a){return 0===this.indexOf(a)}),"function"!=typeof t.endsWith&&(t.endsWith=function(){return this.indexOf===this.length-1}),e(window,"scroll",function(){var a=document.body.clientHeight,b=document.documentElement.offsetHeight,c=document.documentElement.scrollTop||document.body.scrollTop,e=c+b;w||v?Math.abs(e-a)<=150&&d(k,window,700):e===a&&(d(k,window,700),f("block"))})});